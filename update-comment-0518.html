<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论互动 - 大事小事追踪</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/comment.css">
    <link rel="stylesheet" href="assets/event-card.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-back" onclick="window.location.href='event-detail.html'">
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="navbar-title">评论互动</div>
        <div class="navbar-action"></div>
    </div>
    
    <div class="content">
        <!-- 事件详情卡片 -->
        <div class="event-card fade-in">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="user-info flex items-center mb-3">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="头像" class="rounded-full mr-3" style="width:44px;height:44px;object-fit:cover;">
                        <div class="flex flex-col justify-center gap-1">
                            <div class="font-bold text-base leading-tight">王物业</div>
                            <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600 leading-tight">物业管理员</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2" style="height: 30px;">
                    <span class="status-ongoing">进行中</span>
                    <div class="event-menu">
                        <div class="event-menu-btn" onclick="toggleEventMenu()">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        <div class="event-menu-content" id="eventMenu">
                            <div class="menu-item" onclick="showStatusSelector()">
                                <i class="fas fa-exchange-alt"></i>
                                <span>修改状态</span>
                            </div>
                            <div class="menu-item danger" onclick="deleteTimeline()">
                                <i class="fas fa-trash"></i>
                                <span>删除</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="event-content prose prose-sm max-w-none text-gray-800">
                <strong>物业公司查看安装电瓶车门禁系统位置</strong><br>
                详情请参考<a href="https://property.example.com/notice/123" target="_blank" class="text-blue-600 underline">《小区电瓶车管理规定》</a>进行了解。<br>
                现场勘查确定了电瓶车门禁系统的最佳安装位置，将于下周开始施工。
            </p>
            
            <div class="event-images">
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=1" alt="活动图片">
                </div>
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=2" alt="活动图片">
                </div>
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=3" alt="活动图片">
                </div>
            </div>
            
            <div class="event-actions flex justify-between items-center text-sm text-gray-500 mt-2">
                <span>2024-03-20 14:00</span>
                <div class="flex items-center text-secondary">
                    <i class="far fa-comment mr-2"></i>
                    <span>32条评论</span>
                </div>
            </div>
        </div>
        
        <!-- 评论区域 -->
            <!-- 新的结构化讨论区 -->
            <div class="structured-discussion-area px-2 py-3 mb-4">  <!-- 外层容器移除了卡片样式，保留了内外边距 --> 
                <!-- 面包屑导航 -->
                <div class="breadcrumb-nav text-sm text-gray-500 mb-3 p-2 bg-gray-100 rounded-md">
                    <span>主议题</span> &gt; <span>物业改进建议</span> &gt; <span class="font-semibold text-gray-700">安装电瓶车门禁</span>
                </div>

                <!-- 操作栏：查看结构图按钮 和 添加新论点按钮 -->
                <div class="flex justify-between items-center mb-4">
                    <button id="view-structure-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm py-2 px-3 rounded-md flex items-center transition-colors duration-150">
                        <i class="fas fa-sitemap mr-2"></i> 查看结构图
                    </button>
                    <button id="add-main-argument-button" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md flex items-center transition-colors duration-150">
                        <i class="fas fa-plus mr-2"></i> 发表新论点
                    </button>
                </div>

                <!-- 论点列表容器 -->
                <div id="argument-list" class="space-y-3">
                    <!-- 示例论点卡片 - 将由JS动态生成和填充 --> 
                    
                     <!-- 论点 1: 支持 (Pro) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/men/35.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">业主张三</span>
                                    <span class="text-xs text-gray-400">2小时前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">我非常支持安装电瓶车门禁！能有效规范停车，减少乱停放现象，对小区的整体安全和美观都有好处。</p>
                                <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium">支持</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 25</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 2</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 查看回应 (3)</button>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- 论点 2: 反对 (Con) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/women/60.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">居民李女士</span>
                                    <span class="text-xs text-gray-400">1小时前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">坚决反对！我家有两辆电瓶车，来客人了怎么办？高峰期会不会堵在门口？物业有考虑过这些实际问题吗？</p>
                                <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-medium">反对</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 5</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 18</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 查看回应 (5)</button>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- 论点 3: 提问 (Question) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/men/42.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">好奇的王大爷</span>
                                    <span class="text-xs text-gray-400">45分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">这个门禁系统具体是什么牌子的？识别率高不高？如果坏了维修响应快吗？费用是谁出？</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 font-medium">提问</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 10</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 0</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 查看回应 (2)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                     <!-- 论点 4: 建议 (Suggestion/Proposal) - 模拟子论点/孙论点场景 (视觉上一致) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/women/7.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">热心邻居周姐</span>
                                    <span class="text-xs text-gray-400">30分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">我建议在门禁旁边设置一个临时访客通道，并由保安手动登记，这样既能管理也能兼顾临时需求。另外，可以对多车家庭提供第二辆车半价的月卡优惠。</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-medium">建议</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 22</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 1</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 添加回应</button> {/* <!-- 0 回应 --> */}
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- 论点 5: 澄清 (Clarification) - 可能是对某个问题的回复 --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/men/11.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">物业小陈</span>
                                    <span class="text-xs text-gray-400">20分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">针对王大爷的提问：我们选用的门禁系统是XX品牌，识别率99.5%，有24小时维保。首次安装费用由公共维修基金支出，后续维护从业委会划拨。</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 font-medium">澄清</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 8</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 0</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 添加回应</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 论点 6: 补充信息 (Additional Info) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/women/25.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">信息通小赵</span>
                                    <span class="text-xs text-gray-400">15分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">我查了一下，隔壁XX小区去年就装了类似的系统，据说效果还不错，初期有些小问题，后面都解决了。他们当时还公示了费用明细。</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 font-medium">补充信息</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 12</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 0</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 查看回应 (1)</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 论点 7: 担忧 (Concern) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/men/50.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">老刘师傅</span>
                                    <span class="text-xs text-gray-400">10分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">我担心这个门禁系统会不会影响消防车的进出？紧急情况下能保证快速开启吗？安全第一啊！</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-pink-100 text-pink-700 font-medium">担忧</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 30</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 0</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 查看回应 (4)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 论点 8: 中立/观察 (Neutral/Observation) --> 
                    <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150">
                        <div class="flex items-start space-x-3">
                            <img src="https://randomuser.me/api/portraits/women/33.jpg" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-sm text-gray-800">路过的观察员</span>
                                    <span class="text-xs text-gray-400">5分钟前</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">这个事情讨论得挺激烈。任何方案都有利有弊，关键看怎么权衡和后续管理。期待最终的方案能让大多数人满意。</p>
                                 <div class="mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 font-medium">中立/观察</span> {/* <!-- Adjusted neutral color --> */}
                                </div>
                                <div class="flex items-center text-xs text-gray-500 space-x-4">
                                    <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> 3</button>
                                    <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> 0</button>
                                    <button class="hover:text-blue-600 flex items-center transition-colors duration-150"><i class="fas fa-reply mr-1"></i> 添加回应</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- 结束：新的结构化讨论区 -->
    </div>
    
    <!-- 评论输入框 -->
    <div class="comment-input-container">
        <div class="comment-input-wrapper">
            <textarea class="comment-input" placeholder="说点什么..." id="comment-input" style="height: 40px; width: 226px;"></textarea>
        </div>
        <div class="image-upload" onclick="uploadImage()">
            <i class="far fa-image"></i>
        </div>
        <div class="send-btn" onclick="sendComment()">
            <i class="fas fa-paper-plane"></i>
        </div>
    </div>
    
    <!-- 删除确认弹窗 -->
    <div class="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-title">删除评论</div>
            <div class="delete-modal-message">确定要删除这条评论吗？此操作不可恢复。</div>
            <div class="delete-modal-actions">
                <div class="delete-modal-btn cancel" onclick="this.closest('.delete-modal').remove()">取消</div>
                <div class="delete-modal-btn confirm" onclick="deleteComment(this)">删除</div>
            </div>
        </div>
    </div>
    
    <!-- 状态选择器 -->
    <div class="status-selector" id="statusSelector">
        <div class="status-selector-header">
            <div class="status-selector-title">修改进展状态</div>
            <div class="status-selector-close" onclick="hideStatusSelector()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <div class="status-options-container">
            <div class="status-option" onclick="updateStatus('ongoing'); selectOption(this);">
                <div class="status-icon status-ongoing-icon">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">进行中</div>
                </div>
            </div>
            
            <div class="status-option" onclick="updateStatus('completed'); selectOption(this);">
                <div class="status-icon status-completed-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">已结束</div>
                </div>
            </div>
        </div>
        
        <button class="status-cancel-btn" onclick="hideStatusSelector()">取消</button>
    </div>
    
    <!-- 删除进展确认弹窗 -->
    <div class="delete-progress-modal" id="deleteProgressModal">
        <div class="delete-progress-content">
            <div class="delete-progress-icon">
                <i class="fas fa-trash"></i>
            </div>
            <div class="delete-progress-title">删除进展</div>
            <div class="delete-progress-message">确定要删除这条进展吗？此操作不可恢复，删除后相关的评论也将一并删除。</div>
            <div class="delete-progress-actions">
                <div class="delete-progress-btn cancel" onclick="hideDeleteProgressModal()">取消</div>
                <div class="delete-progress-btn confirm" onclick="confirmDeleteProgress()">删除</div>
            </div>
        </div>
    </div>
    
    <script>
        let replyTo = null;
        let commentImages = [];
        const commentInput = document.getElementById('comment-input');
        const commentImagesContainer = document.getElementById('comment-images');
        
        // 分享事件
        function shareEvent() {
            // 实现分享功能
            alert('分享功能开发中...');
        }
        
        // 踩评论
        function dislikeComment(btn) {
            // 检查是否已经踩过
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                btn.style.color = '';
                btn.style.background = '';
            } else {
                btn.classList.add('active');
                btn.style.color = '#ff3b30';
                btn.style.background = 'rgba(255, 59, 48, 0.1)';
                
                // 如果已经点赞，取消点赞
                const likeBtn = btn.previousElementSibling;
                if (likeBtn && likeBtn.classList.contains('active')) {
                    likeBtn.classList.remove('active');
                    likeBtn.style.color = '';
                    likeBtn.style.background = '';
                }
            }
        }
        
        // 踩回复
        function dislikeReply(element) {
            // 检查是否已经踩过
            if (element.classList.contains('active')) {
                element.classList.remove('active');
            } else {
                element.classList.add('active');
                element.style.color = '#ff3b30';
                
                // 如果已经点赞，取消点赞
                const likeElement = element.previousElementSibling;
                if (likeElement && likeElement.classList.contains('active')) {
                    likeElement.classList.remove('active');
                    likeElement.style.color = '';
                }
            }
        }
        
        // 预览图片
        function previewImage(img) {
            // 实现图片预览功能
            alert('图片预览功能开发中...');
        }
        
        // 上传图片
        function uploadImage() {
            if (commentImages.length >= 9) {
                alert('最多只能上传9张图片');
                return;
            }
            // 模拟图片上传
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        commentImages.push(e.target.result);
                        updateCommentImages();
                    }
                    reader.readAsDataURL(file);
                }
            }
            input.click();
        }
        
        // 更新评论图片预览
        function updateCommentImages() {
            commentImagesContainer.innerHTML = '';
            commentImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'comment-input-image';
                div.innerHTML = `
                    <img src="${img}" alt="预览图片">
                    <div class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                commentImagesContainer.appendChild(div);
            });
            if (commentImages.length < 9) {
                const upload = document.createElement('div');
                upload.className = 'image-upload';
                upload.onclick = uploadImage;
                upload.innerHTML = '<i class="far fa-image"></i>';
                commentImagesContainer.appendChild(upload);
            }
        }
        
        // 移除图片
        function removeImage(index) {
            commentImages.splice(index, 1);
            updateCommentImages();
        }
        
        // 发送评论
        function sendComment() {
            const commentText = commentInput.value.trim();
            if (commentText === '') {
                alert('请输入评论内容');
                return;
            }
            // 在这里处理发送评论的逻辑
            alert('评论发送成功');
            commentInput.value = '';
            commentImages = [];
            updateCommentImages();
        }
        
        // 显示删除确认弹窗
        function showDeleteConfirm(btn) {
            const modal = document.createElement('div');
            modal.className = 'delete-modal';
            modal.innerHTML = `
                <div class="delete-modal-content">
                    <div class="delete-modal-title">删除评论</div>
                    <div class="delete-modal-message">确定要删除这条评论吗？此操作不可恢复。</div>
                    <div class="delete-modal-actions">
                        <div class="delete-modal-btn cancel" onclick="this.closest('.delete-modal').remove()">取消</div>
                        <div class="delete-modal-btn confirm" onclick="deleteComment(this)">删除</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 删除评论
        function deleteComment(btn) {
            const modal = btn.closest('.delete-modal');
            const commentCard = btn.closest('.card');
            
            // 添加删除动画
            commentCard.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                commentCard.remove();
                modal.remove();
                
                // 检查是否还有评论
                const commentList = document.querySelector('.comment-list');
                if (!commentList.children.length) {
                    document.getElementById('no-comments').style.display = 'block';
                }
            }, 300);
        }
        
        // 添加删除动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);
        
        // 切换事件菜单
        function toggleEventMenu() {
            const menu = document.getElementById('eventMenu');
            menu.classList.toggle('show');
            
            // 点击其他地方关闭菜单
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.event-menu')) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // 显示状态选择器
        function showStatusSelector() {
            document.getElementById('statusSelector').classList.add('show');
            document.getElementById('eventMenu').classList.remove('show');
        }

        // 隐藏状态选择器
        function hideStatusSelector() {
            document.getElementById('statusSelector').classList.remove('show');
        }

        // 选择选项
        function selectOption(element) {
            // 移除所有选中样式
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 添加选中样式
            element.classList.add('selected');
        }

        // 更新状态
        function updateStatus(status) {
            const statusMap = {
                'ongoing': { 
                    text: '进行中', 
                    class: 'status-ongoing',
                    icon: '<i class="fas fa-circle" style="color: var(--primary-color); margin-right: 4px;"></i>'
                },
                'completed': { 
                    text: '已结束', 
                    class: 'status-completed',
                    icon: '<i class="fas fa-check-circle" style="color: #999999; margin-right: 4px;"></i>'
                }
            };

            // 更新主状态显示
            const statusElement = document.querySelector('.status-ongoing, .status-completed');
            const newStatus = statusMap[status];
            statusElement.innerHTML = newStatus.icon + newStatus.text;
            statusElement.className = newStatus.class;
            
            // 延迟关闭状态选择器，提供反馈时间
            setTimeout(() => {
                hideStatusSelector();
            }, 300);
        }

        // 删除时间线
        function deleteTimeline() {
            showDeleteProgressModal();
        }
        
        // 显示删除进展确认弹窗
        function showDeleteProgressModal() {
            document.getElementById('eventMenu').classList.remove('show');
            const modal = document.getElementById('deleteProgressModal');
            modal.classList.add('show');
            
            // 阻止滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏删除进展确认弹窗
        function hideDeleteProgressModal() {
            const modal = document.getElementById('deleteProgressModal');
            modal.classList.remove('show');
            
            // 恢复滚动
            document.body.style.overflow = '';
        }
        
        // 确认删除进展
        function confirmDeleteProgress() {
            // 添加删除动画
            const eventCard = document.querySelector('.event-card');
            eventCard.style.animation = 'fadeOut 0.5s ease forwards';
            
            // 显示删除中状态
            const confirmBtn = document.querySelector('.delete-progress-btn.confirm');
            const originalText = confirmBtn.textContent;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中';
            confirmBtn.style.pointerEvents = 'none';
            
            // 模拟删除请求
            setTimeout(() => {
                hideDeleteProgressModal();
                
                // 显示成功提示
                const successToast = document.createElement('div');
                successToast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 16px 32px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 2000;
                `;
                successToast.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 进展已删除';
                document.body.appendChild(successToast);
                
                // 2秒后跳转
                setTimeout(() => {
                    window.location.href = 'event-detail.html';
                }, 1500);
            }, 1000);
        }
    </script>

<!-- Add New Argument Modal -->
<div id="addArgumentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display:none; z-index: 50;">
  <div class="relative p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
        <h3 id="addArgumentModalTitle" class="text-lg font-medium text-gray-900">发表论点</h3>
        <button id="closeAddArgumentModal" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>
    <p id="replyingToInfo" class="text-sm text-gray-500 mb-2 py-2 px-3 bg-gray-100 rounded-md" style="display:none;"></p>
    <textarea id="newArgumentText" rows="4" class="w-full p-2.5 text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="请在此输入您的论点内容..."></textarea>
    <div id="newArgumentTagContainer" class="mt-2 mb-3">
        <label for="newArgumentTagSelect" class="block mb-1 text-sm font-medium text-gray-900">选择观点标签:</label>
        <select id="newArgumentTagSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
            <option value="支持">支持</option>
            <option value="反对">反对</option>
            <option value="提问">提问</option>
            <option value="建议">建议</option>
            <option value="澄清">澄清</option>
            <option value="补充信息">补充信息</option>
            <option value="担忧">担忧</option>
            <option value="中立/观察">中立/观察</option>
        </select>
    </div>
    <button id="submitNewArgumentButton" class="mt-3 w-full text-white bg-blue-500 hover:bg-blue-600 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">提交</button>
  </div>
</div>

<!-- View Structure Modal -->
<div id="viewStructureModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display:none; z-index: 50;">
  <div class="relative p-5 border w-11/12 md:w-4/5 lg:w-3/5 shadow-lg rounded-md bg-white" style="max-height: 80vh;">
     <div class="flex justify-between items-center mb-3 sticky top-0 bg-white py-3 border-b z-10">
        <h3 class="text-lg font-medium text-gray-900">讨论结构图</h3>
        <button id="closeViewStructureModal" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
             <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>
    <div id="structureContentContainer" class="mt-2 text-sm text-gray-700 overflow-y-auto" style="max-height: calc(80vh - 100px);"> {/* Adjust max-height considering header/footer of modal */}
        <div id="tree-placeholder" class="p-3 rounded text-sm"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let argumentsData = [];
    let currentParentId = null;
    let currentBreadcrumb = [{ id: null, name: '主议题', type: 'root' }];

    const elements = {
        argumentList: document.getElementById('argument-list'),
        breadcrumbNav: document.querySelector('.breadcrumb-nav'),
        viewStructureButton: document.getElementById('view-structure-button'),
        addArgumentButton: document.getElementById('add-main-argument-button')
    };

    const tagClasses = {
        '支持': 'bg-green-100 text-green-700',
        '反对': 'bg-red-100 text-red-700',
        '提问': 'bg-yellow-100 text-yellow-700',
        '建议': 'bg-blue-100 text-blue-700',
        '澄清': 'bg-indigo-100 text-indigo-700',
        '补充信息': 'bg-purple-100 text-purple-700',
        '担忧': 'bg-pink-100 text-pink-700',
        '中立/观察': 'bg-gray-200 text-gray-700'
    };

    function getTagClasses(tagName) {
        return tagClasses[tagName] || 'bg-gray-100 text-gray-600';
    }

    function initializeData() {
        argumentsData = [
            {
                id: 'arg1',
                parentId: null,
                user: { name: '业主张三', avatar: 'https://randomuser.me/api/portraits/men/35.jpg' },
                timestamp: '2小时前',
                content: '我非常支持安装电瓶车门禁！能有效规范停车，减少乱停放现象，对小区的整体安全和美观都有好处。',
                tag: '支持',
                upvotes: 25,
                downvotes: 2,
                replyCount: 1, // Has one reply: arg1_1
            },
            {
                id: 'arg1_1',
                parentId: 'arg1',
                user: { name: '物业小李', avatar: 'https://randomuser.me/api/portraits/men/36.jpg' },
                timestamp: '1小时前',
                content: '感谢张三业主的积极反馈，我们正在收集各方意见。',
                tag: '澄清',
                upvotes: 10,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg2',
                parentId: null,
                user: { name: '居民李女士', avatar: 'https://randomuser.me/api/portraits/women/60.jpg' },
                timestamp: '1小时前',
                content: '坚决反对！我家有两辆电瓶车，来客人了怎么办？高峰期会不会堵在门口？物业有考虑过这些实际问题吗？',
                tag: '反对',
                upvotes: 5,
                downvotes: 18,
                replyCount: 2, // Has two replies: arg2_1, arg2_2
            },
            {
                id: 'arg2_1',
                parentId: 'arg2',
                user: { name: '访客赵先生', avatar: 'https://randomuser.me/api/portraits/men/40.jpg' },
                timestamp: '30分钟前',
                content: '确实，访客停车是个问题，希望能有临时解决方案。',
                tag: '担忧',
                upvotes: 15,
                downvotes: 1,
                replyCount: 1, // arg2_1_1
            },
            {
                id: 'arg2_1_1',
                parentId: 'arg2_1',
                user: { name: '物业小陈', avatar: 'https://randomuser.me/api/portraits/men/11.jpg' },
                timestamp: '10分钟前',
                content: '针对访客问题，我们计划设置临时二维码扫描进入，每次有效2小时。',
                tag: '建议',
                upvotes: 5,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg2_2',
                parentId: 'arg2',
                user: { name: '业主王芳', avatar: 'https://randomuser.me/api/portraits/women/41.jpg' },
                timestamp: '20分钟前',
                content: '关于高峰期拥堵，可以考虑错峰进入或者加宽入口。',
                tag: '建议',
                upvotes: 8,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg3',
                parentId: null,
                user: { name: '好奇的王大爷', avatar: 'https://randomuser.me/api/portraits/men/42.jpg' },
                timestamp: '45分钟前',
                content: '这个门禁系统具体是什么牌子的？识别率高不高？如果坏了维修响应快吗？费用是谁出？',
                tag: '提问',
                upvotes: 10,
                downvotes: 0,
                replyCount: 1,
            },
             {
                id: 'arg3_1',
                parentId: 'arg3',
                user: { name: '物业小陈', avatar: 'https://randomuser.me/api/portraits/men/11.jpg' },
                timestamp: '20分钟前',
                content: '针对王大爷的提问：我们选用的门禁系统是XX品牌，识别率99.5%，有24小时维保。首次安装费用由公共维修基金支出，后续维护从业委会划拨。',
                tag: '澄清',
                upvotes: 8,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg4',
                parentId: null,
                user: { name: '热心邻居周姐', avatar: 'https://randomuser.me/api/portraits/women/7.jpg' },
                timestamp: '30分钟前',
                content: '我建议在门禁旁边设置一个临时访客通道，并由保安手动登记，这样既能管理也能兼顾临时需求。另外，可以对多车家庭提供第二辆车半价的月卡优惠。',
                tag: '建议',
                upvotes: 22,
                downvotes: 1,
                replyCount: 0,
            },
            {
                id: 'arg5',
                parentId: null,
                user: { name: '信息通小赵', avatar: 'https://randomuser.me/api/portraits/women/25.jpg' },
                timestamp: '15分钟前',
                content: '我查了一下，隔壁XX小区去年就装了类似的系统，据说效果还不错，初期有些小问题，后面都解决了。他们当时还公示了费用明细。',
                tag: '补充信息',
                upvotes: 12,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg6',
                parentId: null,
                user: { name: '老刘师傅', avatar: 'https://randomuser.me/api/portraits/men/50.jpg' },
                timestamp: '10分钟前',
                content: '我担心这个门禁系统会不会影响消防车的进出？紧急情况下能保证快速开启吗？安全第一啊！',
                tag: '担忧',
                upvotes: 30,
                downvotes: 0,
                replyCount: 0,
            },
            {
                id: 'arg7',
                parentId: null,
                user: { name: '路过的观察员', avatar: 'https://randomuser.me/api/portraits/women/33.jpg' },
                timestamp: '5分钟前',
                content: '这个事情讨论得挺激烈。任何方案都有利有弊，关键看怎么权衡和后续管理。期待最终的方案能让大多数人满意。',
                tag: '中立/观察',
                upvotes: 3,
                downvotes: 0,
                replyCount: 0,
            }
        ];
        // Update reply counts based on actual children for demo purposes
        argumentsData.forEach(arg => {
            if (arg.parentId === null) {
                const children = argumentsData.filter(child => child.parentId === arg.id);
                arg.replyCount = children.length;
            }
        });
        // For nested replies, update their parent's replyCount too
         argumentsData.forEach(arg => {
            if (arg.parentId !== null) {
                 const parentArg = argumentsData.find(p => p.id === arg.parentId);
                 if(parentArg){
                    const children = argumentsData.filter(child => child.parentId === parentArg.id);
                    parentArg.replyCount = children.length;
                 }
            }
        });

    }

    function renderArgumentCard(arg) {
        const tagStyle = getTagClasses(arg.tag);
        const replyButtonText = arg.replyCount > 0 ? `查看回应 (${arg.replyCount})` : '添加回应';

        return `
            <div class="argument-card bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150" data-argument-id="${arg.id}">
                <div class="flex items-start space-x-3">
                    <img src="${arg.user.avatar}" alt="用户头像" class="w-10 h-10 rounded-full border-2 border-gray-100">
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm text-gray-800">${arg.user.name}</span>
                            <span class="text-xs text-gray-400">${arg.timestamp}</span>
                        </div>
                        <p class="text-sm text-gray-700 mt-1 mb-2 leading-relaxed">${arg.content}</p>
                        <div class="mb-2">
                            <span class="text-xs px-2 py-0.5 rounded-full ${tagStyle} font-medium">${arg.tag}</span>
                        </div>
                        <div class="flex items-center text-xs text-gray-500 space-x-4">
                            <button class="hover:text-green-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-up mr-1"></i> ${arg.upvotes}</button>
                            <button class="hover:text-red-600 flex items-center transition-colors duration-150"><i class="fas fa-thumbs-down mr-1"></i> ${arg.downvotes}</button>
                            <button class="view-replies-btn hover:text-blue-600 flex items-center transition-colors duration-150" data-arg-id="${arg.id}" data-arg-name="${arg.user.name}的论点">
                                <i class="fas fa-reply mr-1"></i> ${replyButtonText}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function displayArguments(parentId) {
        currentParentId = parentId;
        const filteredArguments = argumentsData.filter(arg => arg.parentId === parentId);
        elements.argumentList.innerHTML = filteredArguments.map(renderArgumentCard).join('');
        updateAddArgumentButtonText();
    }

    function renderBreadcrumb() {
        let html = '';
        currentBreadcrumb.forEach((item, index) => {
            if (index > 0) {
                html += ' &gt; ';
            }
            if (index === currentBreadcrumb.length - 1) {
                html += `<span class="font-semibold text-gray-700">${item.name}</span>`;
            } else {
                html += `<a href="#" class="breadcrumb-link text-blue-500 hover:underline" data-target-id="${item.id}" data-target-type="${item.type}" data-index="${index}">${item.name}</a>`;
            }
        });
        elements.breadcrumbNav.innerHTML = html;
    }
    
    function updateAddArgumentButtonText(){
        if(currentParentId === null){
            elements.addArgumentButton.innerHTML = '<i class="fas fa-plus mr-2"></i> 发表主论点';
        } else {
            elements.addArgumentButton.innerHTML = '<i class="fas fa-plus mr-2"></i> 发表新回应';
        }
    }

    // Event Listeners
    elements.viewStructureButton.addEventListener('click', () => {
        alert('查看结构图 功能待实现');
    });

    elements.addArgumentButton.addEventListener('click', () => {
        const parentArg = currentParentId ? argumentsData.find(arg => arg.id === currentParentId) : null;
        const promptMessage = parentArg ? 
            `在此处为 '${parentArg.user.name}: ${parentArg.content.substring(0,20)}...' 发表回应 (功能待实现)` :
            '在此处发表新的主论点 (功能待实现)';
        alert(promptMessage);
        // TODO: Implement form/modal for adding new argument/reply
    });

    elements.argumentList.addEventListener('click', (event) => {
        const viewRepliesButton = event.target.closest('.view-replies-btn');
        if (viewRepliesButton) {
            const argId = viewRepliesButton.dataset.argId;
            const argName = viewRepliesButton.dataset.argName; // A short name for the argument
            const targetArgument = argumentsData.find(arg => arg.id === argId);

            if (targetArgument) {
                currentBreadcrumb.push({ id: argId, name: targetArgument.content.substring(0, 15)+'...', type: 'argument' });
                displayArguments(argId);
                renderBreadcrumb();
            }
        }
    });

    elements.breadcrumbNav.addEventListener('click', (event) => {
        event.preventDefault();
        const breadcrumbLink = event.target.closest('.breadcrumb-link');
        if (breadcrumbLink) {
            const targetIndex = parseInt(breadcrumbLink.dataset.index);
            const targetId = breadcrumbLink.dataset.targetId === 'null' ? null : breadcrumbLink.dataset.targetId;
            
            currentBreadcrumb = currentBreadcrumb.slice(0, targetIndex + 1);
            displayArguments(targetId);
            renderBreadcrumb();
        }
    });

    // Initialization
    initializeData();
    displayArguments(null); // Display top-level arguments initially
    renderBreadcrumb();

    let nextArgId = 100; // Counter for new argument IDs

    const modalElements = {
        addArgumentModal: document.getElementById('addArgumentModal'),
        closeAddArgumentModal: document.getElementById('closeAddArgumentModal'),
        addArgumentModalTitle: document.getElementById('addArgumentModalTitle'),
        replyingToInfo: document.getElementById('replyingToInfo'),
        newArgumentText: document.getElementById('newArgumentText'),
        newArgumentTagContainer: document.getElementById('newArgumentTagContainer'),
        newArgumentTagSelect: document.getElementById('newArgumentTagSelect'),
        submitNewArgumentButton: document.getElementById('submitNewArgumentButton'),

        viewStructureModal: document.getElementById('viewStructureModal'),
        closeViewStructureModal: document.getElementById('closeViewStructureModal'),
        treePlaceholder: document.getElementById('tree-placeholder')
    };

    function openAddArgumentModal() {
        modalElements.newArgumentText.value = '';
        if (currentParentId === null) { // Adding a main argument
            modalElements.addArgumentModalTitle.textContent = '发表主论点';
            modalElements.replyingToInfo.style.display = 'none';
            modalElements.newArgumentTagContainer.style.display = 'none'; // Main arguments might not have tags or have a different system
        } else { // Adding a reply
            const parentArg = argumentsData.find(arg => arg.id === currentParentId);
            modalElements.addArgumentModalTitle.textContent = '发表回应';
            modalElements.replyingToInfo.textContent = `回应 ${parentArg.user.name}: "${parentArg.content.substring(0, 30)}..."`;
            modalElements.replyingToInfo.style.display = 'block';
            modalElements.newArgumentTagContainer.style.display = 'block';
            modalElements.newArgumentTagSelect.value = '支持'; // Default tag
        }
        modalElements.addArgumentModal.style.display = 'flex';
    }

    function closeAddArgumentModal() {
        modalElements.addArgumentModal.style.display = 'none';
    }

    function handleSubmitNewArgument() {
        const content = modalElements.newArgumentText.value.trim();
        if (!content) {
            alert('论点内容不能为空！');
            return;
        }

        const newArg = {
            id: 'arg' + nextArgId++, // Ensure unique ID
            parentId: currentParentId,
            user: { name: '当前用户', avatar: 'https://randomuser.me/api/portraits/lego/1.jpg' }, // Placeholder user
            timestamp: '刚刚',
            content: content,
            tag: (currentParentId !== null) ? modalElements.newArgumentTagSelect.value : '主论点', // Or handle main argument tags differently
            upvotes: 0,
            downvotes: 0,
            replyCount: 0
        };

        argumentsData.push(newArg);

        if (currentParentId !== null) {
            const parentArg = argumentsData.find(arg => arg.id === currentParentId);
            if (parentArg) {
                parentArg.replyCount = (parentArg.replyCount || 0) + 1;
            }
        }

        displayArguments(currentParentId);
        closeAddArgumentModal();
        // If it's a new main argument, breadcrumb doesn't change. If it's a reply, current view is already updated.
    }

    // Helper function for tag colors
    function getTagColor(tag) {
        switch (tag) { // Simplified, assuming tag is already consistently cased or handle casing here
            case '支持': return 'text-green-700 bg-green-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '反对': return 'text-red-700 bg-red-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '提问': return 'text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '建议': return 'text-yellow-700 bg-yellow-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '澄清': return 'text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '补充信息': return 'text-purple-700 bg-purple-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '担忧': return 'text-pink-700 bg-pink-100 px-2 py-0.5 rounded-full text-xs font-medium';
            case '中立/观察': return 'text-gray-700 bg-gray-200 px-2 py-0.5 rounded-full text-xs font-medium';
            case '主论点': return 'text-teal-700 bg-teal-100 px-2 py-0.5 rounded-full text-xs font-medium';
            default: return 'text-gray-700 bg-gray-100 px-2 py-0.5 rounded-full text-xs font-medium';
        }
    }

    function generateTreeHTML(parentId = null, isRoot = true) {
        const children = argumentsData.filter(arg => arg.parentId === parentId);
        if (children.length === 0) {
            return '';
        }

        const ulClass = isRoot ? 'list-none space-y-3' : 'list-none space-y-3 ml-6 mt-3';
        let listHtml = `<ul class="${ulClass}">`;

        children.forEach(arg => {
            listHtml += `<li class="bg-white p-3 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200 ease-in-out">`;
            listHtml += `<div>`;
            listHtml += `<span class="inline-block ${getTagColor(arg.tag)}">${arg.tag}</span>`;
            listHtml += `<p class="text-gray-800 text-sm my-2 leading-relaxed">${arg.content.substring(0, 150)}${arg.content.length > 150 ? '...' : ''}</p>`;
            listHtml += `<div class="text-xs text-gray-500 mt-2">`;
            listHtml += `<span><i class="fas fa-user mr-1"></i>${arg.user.name}</span>`;
            listHtml += `<span class="mx-2">|</span>`;
            listHtml += `<span><i class="fas fa-clock mr-1"></i>${arg.timestamp}</span>`;
            listHtml += `</div>`;
            listHtml += `</div>`;
            
            const childHtml = generateTreeHTML(arg.id, false);
            if (childHtml) {
                listHtml += childHtml;
            }
            listHtml += '</li>';
        });

        listHtml += '</ul>';
        return listHtml;
    }

    function openViewStructureModal() {
        modalElements.treePlaceholder.innerHTML = generateTreeHTML(null, true);
        modalElements.viewStructureModal.style.display = 'flex';
    }

    function closeViewStructureModal() {
        modalElements.viewStructureModal.style.display = 'none';
    }

    // Update existing event listeners and add new ones for modals
    elements.viewStructureButton.addEventListener('click', openViewStructureModal);
    elements.addArgumentButton.addEventListener('click', openAddArgumentModal);

    modalElements.closeAddArgumentModal.addEventListener('click', closeAddArgumentModal);
    modalElements.submitNewArgumentButton.addEventListener('click', handleSubmitNewArgument);
    modalElements.closeViewStructureModal.addEventListener('click', closeViewStructureModal);

    // Initialization
    initializeData();
    displayArguments(null); // Display top-level arguments initially
    renderBreadcrumb();
});
</script>
</body>
</html>