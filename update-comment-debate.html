<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结构化讨论 - 事件脉络追踪</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/event-card.css">
    <style>
        :root {
            --primary-color: #4F46E5; /* Indigo-600 */
            --primary-color-dark: #4338CA; /* Indigo-700 */
            --primary-color-light: #E0E7FF; /* Indigo-100 */
        }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f7f8fa; 
        }
        .navbar-title {
            font-weight: 500;
        }
        .content {
            padding-bottom: 80px; 
        }
        .event-card-container {
            padding: 1rem;
        }

        .debate-section {
            margin-top: 0.5rem;
            padding: 0 1rem;
        }

        .ai-summary-section {
            background-color: #fff; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .ai-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 500; 
            color: #1f2937;
        }
        .ai-summary-header i.fa-brain {
            color: var(--primary-color);
        }
        .ai-summary-content {
            margin-top: 0.75rem;
            font-size: 0.875rem; 
            color: #4b5563; 
            line-height: 1.6;
            border-top: 1px solid #f3f4f6;
            padding-top: 0.75rem;
        }
        .ai-summary-content ul {
            list-style-type: disc;
            padding-left: 1.25rem; 
        }
        .ai-summary-content strong {
            font-weight: 500; 
            color: #1f2937; 
        }
        .ai-summary-toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .breadcrumb-nav {
            font-size: 0.875rem; 
            color: #6b7280; 
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            overflow-x: auto;
            white-space: nowrap;
        }
        .breadcrumb-nav a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .breadcrumb-nav a:hover {
            text-decoration: underline;
        }
        .breadcrumb-nav span.separator {
            margin: 0 0.35rem;
            color: #9ca3af;
        }
        .breadcrumb-nav .current-level {
            color: #1f2937;
            font-weight: 500;
        }

        .debate-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .debate-controls h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-800 */
        }
        .debate-controls .sort-options button {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #6b7280; 
            font-size: 0.875rem;
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .debate-controls .sort-options button.active,
        .debate-controls .sort-options button:hover {
            color: var(--primary-color);
            font-weight: 500;
            background-color: rgba(79, 70, 229, 0.1);
        }

        .argument-node {
            margin-bottom: 1rem;
            position: relative;
        }
        
        .argument-card {
            background-color: white;
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            padding: 0.75rem 1rem;
            transition: box-shadow 0.2s ease-in-out;
            position: relative; 
        }
        .argument-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04); 
        }

        .argument-node[data-level="1"] > .argument-card { margin-left: 0; }
        .argument-node[data-level="2"] { padding-left: 1.25rem; }
        .argument-node[data-level="3"] { padding-left: 2.5rem; }

        .argument-node[data-level="2"] > .argument-card::before,
        .argument-node[data-level="3"] > .argument-card::before {
            content: '';
            position: absolute;
            left: -0.75rem; 
            top: 20px; /* Adjust to align with the start of content or avatar */
            height: calc(100% - 30px); /* Adjust based on card padding and content */
            width: 2px;
            background-color: #d1d5db; 
            border-radius: 1px;
        }
        /* Specific adjustments for line position based on actual padding */
        .argument-node[data-level="2"] > .argument-card::before { left: calc(-1.25rem + 0.5rem); } 
        .argument-node[data-level="3"] > .argument-card::before { left: calc(-1.25rem + 0.5rem); } 


        .argument-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .argument-header .avatar {
            width: 32px;
            height: 32px;
            border-radius: 9999px; 
            margin-right: 0.75rem;
            object-fit: cover;
        }
        .argument-author-info .author-name {
            font-weight: 500; 
            font-size: 0.875rem; 
            color: #111827;
        }
        .argument-author-info .timestamp {
            font-size: 0.75rem; 
            color: #6b7280; 
        }
        .viewpoint-tag {
            padding: 0.125rem 0.625rem; 
            border-radius: 0.25rem; 
            font-size: 0.7rem; 
            font-weight: 500; 
            margin-left: auto; 
            line-height: 1.2;
            text-transform: uppercase;
        }
        .viewpoint-tag-pro { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0;} 
        .viewpoint-tag-con { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca;} 
        .viewpoint-tag-question { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe;} 
        .viewpoint-tag-suggestion { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a;} 
        .viewpoint-tag-clarification { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd;} 
        .viewpoint-tag-additional-info { background-color: #f3e8ff; color: #581c87; border: 1px solid #e9d5ff;} 
        .viewpoint-tag-concern { background-color: #fff1f2; color: #9f1239; border: 1px solid #ffdde1;} 
        .viewpoint-tag-neutral { background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb;} 

        .argument-content-full {
            font-size: 0.875rem; 
            color: #374151; 
            margin-bottom: 0.75rem;
            line-height: 1.6;
            white-space: pre-wrap; 
        }
        .argument-content-full.collapsed {
            max-height: 4.8em; 
            overflow: hidden;
            position: relative;
        }
        .argument-content-full.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 1.6em;
            background: linear-gradient(to bottom, transparent, white);
        }
        .toggle-content-btn {
            font-size: 0.75rem; 
            color: var(--primary-color);
            cursor: pointer;
            margin-top: 0.25rem;
            display: inline-block;
            background: none; border: none; padding: 0;
        }

        .argument-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem; 
            font-size: 0.875rem; 
            color: #6b7280; 
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 0.75rem;
        }
        .argument-actions .action-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem; 
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: color 0.2s, background-color 0.2s;
        }
        .argument-actions .action-btn:hover {
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.05);
        }
        .argument-actions .action-btn.active-upvote {
            color: #10B981; 
            font-weight: 500;
        }
        .argument-actions .action-btn.active-downvote {
            color: #EF4444; 
            font-weight: 500;
        }
         .argument-actions .action-btn .vote-count {
            font-size: 0.75rem;
            min-width: 10px; 
        }
        .argument-actions .more-options-btn {
            margin-left: auto;
        }

        .argument-children {
            margin-top: 1rem;
        }

        .add-main-argument-btn-container {
            margin: 1.5rem 0 1rem 0;
            text-align: center; 
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.375rem;
            padding: 0.625rem 1.25rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }
        .btn-primary i {
            margin-right: 0.5rem;
        }

        .argument-form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .argument-form-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .argument-form-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .argument-form-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .argument-form-content textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            resize: vertical;
        }
        .tag-selection-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .viewpoint-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .viewpoint-tags-container .tag-option {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px; 
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .viewpoint-tags-container .tag-option:hover {
            border-color: #a5b4fc;
        }
        .viewpoint-tags-container .tag-option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 500;
        }
        .argument-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .btn-secondary {
            background-color: #f3f4f6; 
            color: #374151; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem;
            padding: 0.5rem 1rem; 
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; 
        }

        .bottom-nav-placeholder {
            height: 60px; 
        }

        #no-arguments-message {
            text-align: center;
            color: #6b7280;
            padding: 2rem 0;
            border: 2px dashed #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        #no-arguments-message i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: #9ca3af;
        }

        @media (max-width: 380px) {
            .argument-card {
                padding: 0.75rem;
            }
            .argument-header .avatar {
                width: 28px;
                height: 28px;
                margin-right: 0.5rem;
            }
            .argument-author-info .author-name, .argument-content-full, .argument-actions {
                font-size: 0.8125rem; 
            }
            .viewpoint-tag {
                font-size: 0.65rem;
                padding: 0.1rem 0.5rem;
            }
            .debate-controls .sort-options button {
                font-size: 0.8125rem;
                margin-left: 0.25rem;
            }
            .btn-primary, .btn-secondary {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-back" onclick="window.location.href='event-detail.html'">
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="navbar-title">结构化讨论</div>
        <div class="navbar-action"></div> 
    </div>
    
    <div class="content">
        <div class="event-card-container">
            <div class="event-card fade-in"> 
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="user-info flex items-center mb-3">
                            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="头像" class="rounded-full mr-3" style="width:44px;height:44px;object-fit:cover;">
                            <div class="flex flex-col justify-center gap-1">
                                <div class="font-bold text-base leading-tight">王物业</div>
                                <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600 leading-tight">物业管理员</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2" style="height: 30px;">
                        <span class="status-ongoing">进行中</span>
                    </div>
                </div>
                
                <p class="event-content prose prose-sm max-w-none text-gray-800">
                    <strong>物业公司查看安装电瓶车门禁系统位置</strong><br>
                    详情请参考<a href="#" target="_blank" class="text-blue-600 underline">《小区电瓶车管理规定》</a>进行了解。<br>
                    现场勘查确定了电瓶车门禁系统的最佳安装位置，将于下周开始施工。
                </p>
                
                <div class="event-images">
                    <div class="event-image" onclick="previewImage(this)">
                        <img src="https://picsum.photos/300/300?random=1" alt="活动图片">
                    </div>
                    <div class="event-image" onclick="previewImage(this)">
                        <img src="https://picsum.photos/300/300?random=2" alt="活动图片">
                    </div>
                </div>
                
                <div class="event-actions flex justify-between items-center text-sm text-gray-500 mt-2">
                    <span>2024-03-20 14:00</span>
                </div>
            </div>
        </div>
        
        <div class="debate-section">
            <div class="ai-summary-section" id="aiSummary">
                <div class="ai-summary-header" onclick="toggleAiSummary()">
                    <span><i class="fas fa-brain mr-2"></i> AI 速览</span>
                    <i class="fas fa-chevron-down transition-transform duration-200 ai-summary-toggle-icon" id="aiSummaryToggleIcon"></i>
                </div>
                <div class="ai-summary-content hidden" id="aiSummaryContent">
                    <p><strong>核心议题：</strong>关于小区是否应增设宠物乐园。</p>
                    <p><strong>主要观点阵营：</strong></p>
                    <ul>
                        <li><strong>支持方：</strong>认为可以为宠物提供活动空间，增进邻里交流，提升社区幸福感。</li>
                        <li><strong>反对方：</strong>担心噪音扰民、卫生问题难保障以及管理维护成本高昂。</li>
                        <li><strong>中立/建议：</strong>提出折中方案，如限定宠物乐园开放时间、增设宠物粪便处理设施、业主共同承担管理责任等。</li>
                    </ul>
                    <p><strong>主要分歧点：</strong>乐园选址的合理性、建设资金的来源、后期管理维护责任的明确划分。</p>
                    <p><strong>潜在共识：</strong>多数居民认可宠物友好社区的理念，但具体实施细节需充分讨论。</p>
                    <button class="text-xs text-blue-600 hover:underline mt-2" onclick="refreshAiSummary(event)">刷新摘要</button>
                </div>
            </div>

            <div class="breadcrumb-nav" id="breadcrumbNav">
                <a href="#" onclick="navigateToArgument(event, null)">核心议题</a>
            </div>

            <div class="debate-controls">
                <h3 class="text-lg font-semibold text-gray-800">全部论点</h3>
                <div class="sort-options">
                    <button class="active" onclick="sortArguments(event, 'hot')">热度</button>
                    <button onclick="sortArguments(event, 'latest')">最新</button>
                    <button onclick="sortArguments(event, 'oldest')">最早</button>
                </div>
            </div>

            <div class="debate-tree" id="debateTree">
                <!-- Arguments will be dynamically inserted here by JavaScript -->
            </div>
            <div id="no-arguments-message" style="display: none;">
                <i class="far fa-comments"></i>
                <p class="font-semibold">暂无讨论</p>
                <p>成为第一个发起议题的人吧！</p>
            </div>

            <div class="add-main-argument-btn-container">
                <button class="btn-primary" onclick="openArgumentForm(null)">
                    <i class="fas fa-plus-circle"></i> 发起主论点
                </button>
            </div>
        </div>
    </div>

    <!-- Argument Form Modal -->
    <div class="argument-form-modal" id="argumentFormModal">
        <div class="argument-form-content">
            <h3 id="argumentFormTitle">发起主论点</h3>
            <textarea id="argumentFormTextarea" placeholder="请输入您的论点内容..."></textarea>
            <div id="tagSelectionContainer" style="display: none;">
                <label class="tag-selection-label">选择观点标签:</label>
                <div class="viewpoint-tags-container" id="viewpointTagsContainer">
                    <!-- Tags will be populated by JS -->
                </div>
            </div>
            <div class="argument-form-actions">
                <button class="btn-secondary" onclick="closeArgumentForm()">取消</button>
                <button class="btn-primary" onclick="submitArgumentForm()">提交</button>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav-placeholder"></div>

    <script>
        let currentEditingArgumentId = null; // For replying to a specific argument
        let currentArgumentLevel = 0;
        let argumentsData = [
            {
                id: 'arg1',
                parentId: null,
                level: 1,
                author: '李业主',
                avatar: 'https://randomuser.me/api/portraits/women/44.jpg',
                timestamp: '3小时前',
                content: '我认为小区应该增设一个专门的宠物乐园。现在养宠物的家庭越来越多，宠物也需要有自己的活动空间，这样既能满足宠物需求，也能减少在公共绿地上对其他居民的影响。而且，宠物乐园也能成为邻里交流的好地方。\n\n主要理由：\n1. 宠物有专属活动区，减少人宠冲突。\n2. 促进养宠邻居交流，和谐社区氛围。\n3. 提升小区整体居住品质。',
                upvotes: 15,
                downvotes: 2,
                userVote: null, // 'up', 'down', or null
                children: [
                    {
                        id: 'arg1-1',
                        parentId: 'arg1',
                        level: 2,
                        author: '赵小明',
                        avatar: 'https://randomuser.me/api/portraits/men/50.jpg',
                        timestamp: '2小时前',
                        tag: '支持',
                        content: '非常同意！我家狗狗每天都憋坏了，有个乐园能让它们尽情奔跑，对它们的健康也好。希望尽快落实！',
                        upvotes: 8,
                        downvotes: 0,
                        userVote: 'up',
                        children: [
                            {
                                id: 'arg1-1-1',
                                parentId: 'arg1-1',
                                level: 3,
                                author: '孙阿姨',
                                avatar: 'https://randomuser.me/api/portraits/women/30.jpg',
                                timestamp: '1小时前',
                                tag: '提问',
                                content: '那宠物乐园的卫生谁来负责呢？会不会反而更脏？需要有明确的清洁和管理方案。',
                                upvotes: 3,
                                downvotes: 1,
                                userVote: null,
                                children: []
                            }
                        ]
                    },
                    {
                        id: 'arg1-2',
                        parentId: 'arg1',
                        level: 2,
                        author: '周大爷',
                        avatar: 'https://randomuser.me/api/portraits/men/60.jpg',
                        timestamp: '1小时前',
                        tag: '反对',
                        content: '我不赞成。小区本来绿化就少，再划一块地给宠物，我们老年人活动的地方就更少了。而且宠物叫起来也吵，影响休息。希望能优先考虑大多数非养宠居民的感受。',
                        upvotes: 5,
                        downvotes: 11,
                        userVote: 'down',
                        children: []
                    },
                    {
                        id: 'arg1-3',
                        parentId: 'arg1',
                        level: 2,
                        author: '王规划师',
                        avatar: 'https://randomuser.me/api/portraits/men/61.jpg',
                        timestamp: '45分钟前',
                        tag: '建议',
                        content: '可以考虑在小区边缘区域设置，远离住宅楼。同时，乐园需要有围栏，并规定开放时间，减少对其他居民的干扰。资金方面可以众筹一部分，物业补贴一部分。',
                        upvotes: 12,
                        downvotes: 1,
                        userVote: null,
                        children: []
                    }
                ]
            },
            {
                id: 'arg2',
                parentId: null,
                level: 1,
                author: '物业小陈',
                avatar: 'https://randomuser.me/api/portraits/men/33.jpg',
                timestamp: '刚刚',
                content: '关于宠物乐园的选址和管理，物业可以牵头组织一次业主意见征询会，大家共同商议具体方案。初步设想可以利用小区西北角那片闲置空地，面积约50平方米。\n\n我们会制定详细的问卷，并通过线上和线下渠道收集大家的意见。',
                upvotes: 22,
                downvotes: 0,
                userVote: null,
                children: [
                     {
                        id: 'arg2-1',
                        parentId: 'arg2',
                        level: 2,
                        author: '张女士',
                        avatar: 'https://randomuser.me/api/portraits/women/31.jpg',
                        timestamp: '10分钟前',
                        tag: '澄清',
                        content: '物业小陈你好，请问西北角空地具体位置是靠近垃圾中转站那块吗？如果是，可能气味不太好，需要再斟酌。',
                        upvotes: 4,
                        downvotes: 0,
                        userVote: null,
                        children: []
                    },
                    {
                        id: 'arg2-2',
                        parentId: 'arg2',
                        level: 2,
                        author: '刘师傅',
                        avatar: 'https://randomuser.me/api/portraits/men/34.jpg',
                        timestamp: '5分钟前',
                        tag: '担忧',
                        content: '如果建在那里，会不会影响消防通道？那块地旁边好像是消防车的回转区域。安全第一。',
                        upvotes: 7,
                        downvotes: 0,
                        userVote: null,
                        children: []
                    }
                ]
            }
        ];

        const viewpointTags = [
            { label: '支持', value: '支持', class: 'viewpoint-tag-pro' },
            { label: '反对', value: '反对', class: 'viewpoint-tag-con' },
            { label: '提问', value: '提问', class: 'viewpoint-tag-question' },
            { label: '建议', value: '建议', class: 'viewpoint-tag-suggestion' },
            { label: '澄清', value: '澄清', class: 'viewpoint-tag-clarification' },
            { label: '补充信息', value: '补充信息', class: 'viewpoint-tag-additional-info' },
            { label: '担忧', value: '担忧', class: 'viewpoint-tag-concern' },
            { label: '中立/观察', value: '中立/观察', class: 'viewpoint-tag-neutral' }
        ];

        function getTagClass(tagName) {
            const tag = viewpointTags.find(t => t.value === tagName);
            return tag ? tag.class : 'viewpoint-tag-neutral';
        }

        function renderArguments(parentElement, args, currentLevel = 1) {
            args.sort((a,b) => (b.upvotes - b.downvotes) - (a.upvotes - a.downvotes)); // Default sort by hotness

            args.forEach(arg => {
                const argumentNode = document.createElement('div');
                argumentNode.className = 'argument-node';
                argumentNode.dataset.id = arg.id;
                argumentNode.dataset.level = arg.level;
                if (arg.parentId) argumentNode.dataset.parentId = arg.parentId;

                const tagHtml = arg.level > 1 ? `<span class="viewpoint-tag ${getTagClass(arg.tag)}">${arg.tag}</span>` : '';
                
                argumentNode.innerHTML = `
                    <div class="argument-card">
                        <div class="argument-header">
                            <img src="${arg.avatar}" alt="用户头像" class="avatar">
                            <div class="argument-author-info">
                                <span class="author-name">${arg.author}</span>
                                <span class="timestamp">${arg.timestamp}</span>
                            </div>
                            ${tagHtml}
                        </div>
                        <div class="argument-content-full collapsed" id="content-${arg.id}">${arg.content.replace(/\n/g, '<br>')}</div>
                        <button class="toggle-content-btn" onclick="toggleContent(event, '${arg.id}')">展开</button>
                        <div class="argument-actions mt-2">
                            <span class="action-btn ${arg.userVote === 'up' ? 'active-upvote' : ''}" onclick="vote(event, '${arg.id}', 'up')">
                                <i class="far fa-thumbs-up"></i> <span class="vote-count">${arg.upvotes}</span>
                            </span>
                            <span class="action-btn ${arg.userVote === 'down' ? 'active-downvote' : ''}" onclick="vote(event, '${arg.id}', 'down')">
                                <i class="far fa-thumbs-down"></i> <span class="vote-count">${arg.downvotes}</span>
                            </span>
                            ${arg.level < 3 ? `<span class="action-btn reply-btn" onclick="openArgumentForm('${arg.id}', ${arg.level + 1})"><i class="fas fa-reply"></i> 回应</span>` : ''}
                            <span class="action-btn more-options-btn" onclick="moreOptions(event, '${arg.id}')"><i class="fas fa-ellipsis-h"></i></span>
                        </div>
                    </div>
                    <div class="argument-children"></div>
                `;
                parentElement.appendChild(argumentNode);
                
                // Initialize content toggle state
                const contentDiv = argumentNode.querySelector(`#content-${arg.id}`);
                const toggleBtn = argumentNode.querySelector('.toggle-content-btn');
                if (contentDiv.scrollHeight <= contentDiv.clientHeight) { // If content is not overflowing
                    toggleBtn.style.display = 'none';
                    contentDiv.classList.remove('collapsed');
                } else {
                    toggleBtn.textContent = '展开';
                }

                if (arg.children && arg.children.length > 0) {
                    const childrenContainer = argumentNode.querySelector('.argument-children');
                    renderArguments(childrenContainer, arg.children, arg.level + 1);
                }
            });
        }

        function findArgumentById(argsArray, id) {
            for (let arg of argsArray) {
                if (arg.id === id) return arg;
                if (arg.children && arg.children.length > 0) {
                    const found = findArgumentById(arg.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function toggleAiSummary() {
            const content = document.getElementById('aiSummaryContent');
            const icon = document.getElementById('aiSummaryToggleIcon');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotated');
        }

        function refreshAiSummary(event) {
            event.stopPropagation();
            alert('正在刷新AI摘要 (模拟)...');
            setTimeout(() => {
                const summaryContent = document.getElementById('aiSummaryContent').querySelector('ul');
                summaryContent.innerHTML = `
                    <li><strong>支持方：</strong>(已更新) 强调宠物福利和社区互动，认为能极大提升幸福感。</li>
                    <li><strong>反对方：</strong>(已更新) 持续关注环境和秩序问题，并提出管理成本分摊疑问。</li>
                    <li><strong>中立/建议：</strong>(已更新) 建议物业公示几种备选方案及预算，供业主投票。</li>
                `;
                alert('AI摘要已更新！');
            }, 1000);
        }

        function toggleContent(event, argumentId) {
            event.stopPropagation();
            const contentDiv = document.getElementById(`content-${argumentId}`);
            const button = event.target;
            contentDiv.classList.toggle('collapsed');
            if (contentDiv.classList.contains('collapsed')) {
                button.textContent = '展开';
            } else {
                button.textContent = '收起';
            }
        }

        function vote(event, argumentId, type) {
            event.stopPropagation();
            const arg = findArgumentById(argumentsData, argumentId);
            if (!arg) return;

            const upvoteBtn = event.currentTarget.parentElement.querySelector('.action-btn:first-child');
            const downvoteBtn = event.currentTarget.parentElement.querySelector('.action-btn:nth-child(2)');
            const upvoteCountSpan = upvoteBtn.querySelector('.vote-count');
            const downvoteCountSpan = downvoteBtn.querySelector('.vote-count');

            if (type === 'up') {
                if (arg.userVote === 'up') { // Unvote up
                    arg.upvotes--;
                    arg.userVote = null;
                    upvoteBtn.classList.remove('active-upvote');
                } else {
                    if (arg.userVote === 'down') arg.downvotes--; // Remove previous downvote
                    arg.upvotes++;
                    arg.userVote = 'up';
                    upvoteBtn.classList.add('active-upvote');
                    downvoteBtn.classList.remove('active-downvote');
                }
            } else if (type === 'down') {
                if (arg.userVote === 'down') { // Unvote down
                    arg.downvotes--;
                    arg.userVote = null;
                    downvoteBtn.classList.remove('active-downvote');
                } else {
                    if (arg.userVote === 'up') arg.upvotes--; // Remove previous upvote
                    arg.downvotes++;
                    arg.userVote = 'down';
                    downvoteBtn.classList.add('active-downvote');
                    upvoteBtn.classList.remove('active-upvote');
                }
            }
            upvoteCountSpan.textContent = arg.upvotes;
            downvoteCountSpan.textContent = arg.downvotes;
        }

        function moreOptions(event, argumentId) {
            event.stopPropagation();
            const options = ['举报该论点'];
            // In a real app, check ownership/admin rights for delete
            // For demo, let's assume user can delete their own or if admin
            const arg = findArgumentById(argumentsData, argumentId);
            // Simple check, replace with actual user ID check
            if (arg && (arg.author === '当前用户' || arg.author === '李业主' /*mock owner*/)) {
                 options.push('删除该论点');
            }
            const choice = prompt(`操作论点 "${arg ? arg.content.substring(0,20)+'...' : argumentId}":\n${options.join('\n')}`);
            if (choice === '举报该论点') {
                alert(`论点 ${argumentId} 已举报。`);
            } else if (choice === '删除该论点') {
                if(confirm('确定要删除这个论点及其所有子论点吗？此操作不可恢复。')){
                    deleteArgumentRecursive(argumentsData, argumentId, null);
                    rerenderDebateTree();
                    alert(`论点 ${argumentId} 已删除。`);
                }
            }
        }
        
        function deleteArgumentRecursive(argsArray, idToDelete, parentArg) {
            for (let i = 0; i < argsArray.length; i++) {
                if (argsArray[i].id === idToDelete) {
                    argsArray.splice(i, 1);
                    return true; 
                }
                if (argsArray[i].children && argsArray[i].children.length > 0) {
                    if (deleteArgumentRecursive(argsArray[i].children, idToDelete, argsArray[i])) {
                        return true;
                    }
                }
            }
            return false;
        }

        function openArgumentForm(parentId = null, level = 1) {
            currentEditingArgumentId = parentId;
            currentArgumentLevel = level;
            const modal = document.getElementById('argumentFormModal');
            const title = document.getElementById('argumentFormTitle');
            const textarea = document.getElementById('argumentFormTextarea');
            const tagContainer = document.getElementById('tagSelectionContainer');
            const viewpointTagsDiv = document.getElementById('viewpointTagsContainer');
            
            textarea.value = '';
            title.textContent = parentId ? `回应论点 (层级 ${level})` : '发起主论点';
            
            if (parentId) { // Replying to an argument, show tags
                tagContainer.style.display = 'block';
                viewpointTagsDiv.innerHTML = ''; // Clear previous tags
                viewpointTags.forEach(tag => {
                    const tagButton = document.createElement('button');
                    tagButton.className = 'tag-option';
                    tagButton.textContent = tag.label;
                    tagButton.dataset.value = tag.value;
                    tagButton.onclick = (e) => {
                        e.preventDefault(); // Prevent form submission if it were a real form
                        // Remove 'selected' from other tags
                        viewpointTagsDiv.querySelectorAll('.tag-option').forEach(btn => btn.classList.remove('selected'));
                        // Add 'selected' to clicked tag
                        tagButton.classList.add('selected');
                    };
                    viewpointTagsDiv.appendChild(tagButton);
                });
            } else {
                tagContainer.style.display = 'none';
            }
            modal.classList.add('visible');
        }

        function closeArgumentForm() {
            document.getElementById('argumentFormModal').classList.remove('visible');
            currentEditingArgumentId = null;
            currentArgumentLevel = 0;
        }

        function submitArgumentForm() {
            const text = document.getElementById('argumentFormTextarea').value.trim();
            if (!text) {
                alert('请输入论点内容。');
                return;
            }

            let selectedTag = null;
            if (currentEditingArgumentId) { // If replying, a tag must be selected
                const selectedTagButton = document.getElementById('viewpointTagsContainer').querySelector('.tag-option.selected');
                if (!selectedTagButton) {
                    alert('请选择一个观点标签。');
                    return;
                }
                selectedTag = selectedTagButton.dataset.value;
            }

            const newArgument = {
                id: 'arg' + Date.now(),
                parentId: currentEditingArgumentId,
                level: currentArgumentLevel,
                author: '当前用户', // Replace with actual user
                avatar: 'https://randomuser.me/api/portraits/lego/0.jpg', // Replace with actual user avatar
                timestamp: '刚刚',
                tag: selectedTag, // Null for main arguments
                content: text,
                upvotes: 0,
                downvotes: 0,
                userVote: null,
                children: []
            };

            if (currentEditingArgumentId) {
                const parentArg = findArgumentById(argumentsData, currentEditingArgumentId);
                if (parentArg) {
                    parentArg.children.push(newArgument);
                }
            } else {
                argumentsData.push(newArgument);
            }
            rerenderDebateTree();
            closeArgumentForm();
        }

        function sortArguments(event, criteria) {
            event.stopPropagation();
            document.querySelectorAll('.debate-controls .sort-options button').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            function sortRecursive(args) {
                if (criteria === 'hot') {
                    args.sort((a,b) => (b.upvotes - b.downvotes) - (a.upvotes - a.downvotes));
                } else if (criteria === 'latest') {
                    // Assuming timestamp can be parsed or is a comparable value, for mock, use ID
                    args.sort((a,b) => parseInt(b.id.replace('arg','')) - parseInt(a.id.replace('arg',''))); 
                } else if (criteria === 'oldest') {
                    args.sort((a,b) => parseInt(a.id.replace('arg','')) - parseInt(b.id.replace('arg',''))); 
                }
                args.forEach(arg => {
                    if (arg.children && arg.children.length > 0) sortRecursive(arg.children);
                });
            }
            sortRecursive(argumentsData);
            rerenderDebateTree();
        }

        function navigateToArgument(event, argumentId) {
            event.preventDefault();
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            if (!argumentId) { // Navigate to root
                breadcrumbNav.innerHTML = '<a href="#" onclick="navigateToArgument(event, null)">核心议题</a>';
                // In a real app, you might want to re-render or scroll to top
                alert('已导航到核心议题 (功能模拟)');
                return;
            }

            const path = [];
            function findPath(args, id, currentPath) {
                for (let arg of args) {
                    const newPath = [...currentPath, arg];
                    if (arg.id === id) return newPath;
                    if (arg.children) {
                        const foundPath = findPath(arg.children, id, newPath);
                        if (foundPath) return foundPath;
                    }
                }
                return null;
            }
            
            const argumentPath = findPath(argumentsData, argumentId, []);
            if (argumentPath) {
                let breadcrumbHtml = '<a href="#" onclick="navigateToArgument(event, null)">核心议题</a>';
                argumentPath.forEach((argInPath, index) => {
                    breadcrumbHtml += ` <span class="separator">&gt;</span> `;
                    if (index === argumentPath.length - 1) { // Current item
                        breadcrumbHtml += `<span class="current-level">${argInPath.content.substring(0,15)}...</span>`;
                    } else {
                        breadcrumbHtml += `<a href="#" onclick="navigateToArgument(event, '${argInPath.id}')">${argInPath.content.substring(0,15)}...</a>`;
                    }
                });
                breadcrumbNav.innerHTML = breadcrumbHtml;
                // Scroll to element (optional)
                const element = document.querySelector(`.argument-node[data-id="${argumentId}"]`);
                if (element) element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert('导航失败：未找到论点。');
            }
        }

        function rerenderDebateTree() {
            const debateTreeContainer = document.getElementById('debateTree');
            const noArgsMessage = document.getElementById('no-arguments-message');
            debateTreeContainer.innerHTML = ''; // Clear existing tree
            if (argumentsData.length === 0) {
                noArgsMessage.style.display = 'block';
            } else {
                noArgsMessage.style.display = 'none';
                renderArguments(debateTreeContainer, argumentsData);
            }
        }

        function previewImage(imgElement) {
            const imgSrc = imgElement.querySelector('img').src;
            alert('图片预览: ' + imgSrc + ' (功能开发中)');
        }

        document.addEventListener('DOMContentLoaded', () => {
            rerenderDebateTree();
            // Initial breadcrumb
            navigateToArgument(new Event('DOMContentLoaded'), null); 
        });

    </script>
</body>
</html>
