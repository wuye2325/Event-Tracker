<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论互动 - 大事小事追踪</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/comment.css">
    <link rel="stylesheet" href="assets/event-card.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-back" onclick="window.location.href='event-detail.html'">
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="navbar-title">评论互动</div>
        <div class="navbar-action"></div>
    </div>
    
    <div class="content">
        <!-- 事件详情卡片 -->
        <div class="event-card fade-in">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="user-info flex items-center mb-3">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="头像" class="rounded-full mr-3" style="width:44px;height:44px;object-fit:cover;">
                        <div class="flex flex-col justify-center gap-1">
                            <div class="font-bold text-base leading-tight">王物业</div>
                            <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600 leading-tight">物业管理员</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2" style="height: 30px;">
                    <span class="status-ongoing">进行中</span>
                    <div class="event-menu">
                        <div class="event-menu-btn" onclick="toggleEventMenu()">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        <div class="event-menu-content" id="eventMenu">
                            <div class="menu-item" onclick="showStatusSelector()">
                                <i class="fas fa-exchange-alt"></i>
                                <span>修改状态</span>
                            </div>
                            <div class="menu-item danger" onclick="deleteTimeline()">
                                <i class="fas fa-trash"></i>
                                <span>删除</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="event-content prose prose-sm max-w-none text-gray-800">
                <strong>物业公司查看安装电瓶车门禁系统位置</strong><br>
                详情请参考<a href="https://property.example.com/notice/123" target="_blank" class="text-blue-600 underline">《小区电瓶车管理规定》</a>进行了解。<br>
                现场勘查确定了电瓶车门禁系统的最佳安装位置，将于下周开始施工。
            </p>
            
            <div class="event-images">
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=1" alt="活动图片">
                </div>
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=2" alt="活动图片">
                </div>
                <div class="event-image" onclick="previewImage(this)">
                    <img src="https://picsum.photos/300/300?random=3" alt="活动图片">
                </div>
            </div>
            
            <div class="event-actions flex justify-between items-center text-sm text-gray-500 mt-2">
                <span>2024-03-20 14:00</span>
                <div class="flex items-center text-secondary">
                    <i class="far fa-comment mr-2"></i>
                    <span>32条评论</span>
                </div>
            </div>
        </div>
        
        <!-- 评论区域 -->
        <div class="comment-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="font-bold">全部评论</h3>
                <div class="comment-sort">
                    <span class="sort-item active" onclick="sortComments('latest')">最新</span>
                    <span class="sort-item" onclick="sortComments('hot')">最热</span>
                </div>
            </div>
            
            <!-- 评论列表 -->
            <div class="comment-list">
                <!-- 主评论 -->
                <div class="card">
                    <div class="flex items-start">
                        <img src="https://picsum.photos/40/40?random=1" alt="用户头像" class="avatar">
                        <div class="flex-1 ml-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">张三</span>
                                <span class="text-sm text-gray-500">2024-03-20 14:30</span>
                            </div>
                            <p class="text-gray-800 mb-3">这是一条更新评论内容。</p>
                            <div class="image-grid">
                                <img src="https://picsum.photos/200/200?random=4" alt="评论图片">
                                <img src="https://picsum.photos/200/200?random=5" alt="评论图片">
                                <img src="https://picsum.photos/200/200?random=6" alt="评论图片">
                            </div>
                            <div class="flex items-center gap-4 mt-3">
                                <button class="btn-secondary" onclick="likeComment(this)">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <button class="btn-secondary" onclick="dislikeComment(this)">
                                    <i class="fas fa-thumbs-down"></i>
                                </button>
                                <button class="btn-secondary" onclick="replyComment(this)">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn-secondary text-error" onclick="showDeleteConfirm(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 回复列表 -->
                    <div class="comment-replies">
                        <!-- 回复项 -->
                        <div class="reply-item">
                            <img src="https://picsum.photos/32/32?random=7" alt="回复用户头像" class="reply-avatar">
                            <div class="reply-content">
                                <div class="reply-header">
                                    <span class="reply-author">李四</span>
                                    <span class="reply-time">2024-03-20 14:35</span>
                                </div>
                                <p class="reply-text">这是回复内容。</p>
                                <div class="reply-actions">
                                    <span class="reply-action" onclick="likeReply(this)">
                                        <i class="fas fa-thumbs-up"></i>
                                    </span>
                                    <span class="reply-action" onclick="dislikeReply(this)">
                                        <i class="fas fa-thumbs-down"></i>
                                    </span>
                                    <span class="reply-action" onclick="replyToReply(this)">
                                        <i class="fas fa-reply"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 展开更多回复 -->
                        <div class="expand-replies">
                            <i class="fas fa-chevron-down"></i>
                            <span>展开</span>
                        </div>
                    </div>
                </div>
                
                <!-- 更多评论 -->
                <div class="card">
                    <div class="flex items-start">
                        <img src="https://picsum.photos/40/40?random=8" alt="用户头像" class="avatar">
                        <div class="flex-1 ml-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">刘业主</span>
                                <span class="text-sm text-gray-500">3小时前</span>
                            </div>
                            <p class="text-gray-800 mb-3">这个活动很有意义，我会带着孩子一起参加，让他们也学习一下消防安全知识。</p>
                            <div class="flex items-center gap-4 mt-3">
                                <button class="btn-secondary" onclick="likeComment(this)">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <button class="btn-secondary" onclick="dislikeComment(this)">
                                    <i class="fas fa-thumbs-down"></i>
                                </button>
                                <button class="btn-secondary" onclick="replyComment(this)">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn-secondary text-error" onclick="showDeleteConfirm(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 无评论提示 -->
            <div id="no-comments" class="no-comments" style="display: none;">
                <i class="far fa-comments"></i>
                <p class="font-bold mb-2">暂无评论</p>
                <p class="text-secondary">快来发表第一条评论吧</p>
            </div>
        </div>
    </div>
    
    <!-- 评论输入框 -->
    <div class="comment-input-container">
        <div class="comment-input-wrapper">
            <textarea class="comment-input" placeholder="说点什么..." id="comment-input" style="height: 40px; width: 226px;"></textarea>
        </div>
        <div class="image-upload" onclick="uploadImage()">
            <i class="far fa-image"></i>
        </div>
        <div class="send-btn" onclick="sendComment()">
            <i class="fas fa-paper-plane"></i>
        </div>
    </div>
    
    <!-- 删除确认弹窗 -->
    <div class="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-title">删除评论</div>
            <div class="delete-modal-message">确定要删除这条评论吗？此操作不可恢复。</div>
            <div class="delete-modal-actions">
                <div class="delete-modal-btn cancel" onclick="this.closest('.delete-modal').remove()">取消</div>
                <div class="delete-modal-btn confirm" onclick="deleteComment(this)">删除</div>
            </div>
        </div>
    </div>
    
    <!-- 状态选择器 -->
    <div class="status-selector" id="statusSelector">
        <div class="status-selector-header">
            <div class="status-selector-title">修改进展状态</div>
            <div class="status-selector-close" onclick="hideStatusSelector()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <div class="status-options-container">
            <div class="status-option" onclick="updateStatus('ongoing'); selectOption(this);">
                <div class="status-icon status-ongoing-icon">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">进行中</div>
                </div>
            </div>
            
            <div class="status-option" onclick="updateStatus('completed'); selectOption(this);">
                <div class="status-icon status-completed-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">已结束</div>
                </div>
            </div>
        </div>
        
        <button class="status-cancel-btn" onclick="hideStatusSelector()">取消</button>
    </div>
    
    <!-- 删除进展确认弹窗 -->
    <div class="delete-progress-modal" id="deleteProgressModal">
        <div class="delete-progress-content">
            <div class="delete-progress-icon">
                <i class="fas fa-trash"></i>
            </div>
            <div class="delete-progress-title">删除进展</div>
            <div class="delete-progress-message">确定要删除这条进展吗？此操作不可恢复，删除后相关的评论也将一并删除。</div>
            <div class="delete-progress-actions">
                <div class="delete-progress-btn cancel" onclick="hideDeleteProgressModal()">取消</div>
                <div class="delete-progress-btn confirm" onclick="confirmDeleteProgress()">删除</div>
            </div>
        </div>
    </div>
    
    <script>
        let replyTo = null;
        let commentImages = [];
        const commentInput = document.getElementById('comment-input');
        const commentImagesContainer = document.getElementById('comment-images');
        
        // 分享事件
        function shareEvent() {
            // 实现分享功能
            alert('分享功能开发中...');
        }
        
        // 踩评论
        function dislikeComment(btn) {
            // 检查是否已经踩过
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                btn.style.color = '';
                btn.style.background = '';
            } else {
                btn.classList.add('active');
                btn.style.color = '#ff3b30';
                btn.style.background = 'rgba(255, 59, 48, 0.1)';
                
                // 如果已经点赞，取消点赞
                const likeBtn = btn.previousElementSibling;
                if (likeBtn && likeBtn.classList.contains('active')) {
                    likeBtn.classList.remove('active');
                    likeBtn.style.color = '';
                    likeBtn.style.background = '';
                }
            }
        }
        
        // 踩回复
        function dislikeReply(element) {
            // 检查是否已经踩过
            if (element.classList.contains('active')) {
                element.classList.remove('active');
            } else {
                element.classList.add('active');
                element.style.color = '#ff3b30';
                
                // 如果已经点赞，取消点赞
                const likeElement = element.previousElementSibling;
                if (likeElement && likeElement.classList.contains('active')) {
                    likeElement.classList.remove('active');
                    likeElement.style.color = '';
                }
            }
        }
        
        // 预览图片
        function previewImage(img) {
            // 实现图片预览功能
            alert('图片预览功能开发中...');
        }
        
        // 上传图片
        function uploadImage() {
            if (commentImages.length >= 9) {
                alert('最多只能上传9张图片');
                return;
            }
            // 模拟图片上传
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        commentImages.push(e.target.result);
                        updateCommentImages();
                    }
                    reader.readAsDataURL(file);
                }
            }
            input.click();
        }
        
        // 更新评论图片预览
        function updateCommentImages() {
            commentImagesContainer.innerHTML = '';
            commentImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'comment-input-image';
                div.innerHTML = `
                    <img src="${img}" alt="预览图片">
                    <div class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                commentImagesContainer.appendChild(div);
            });
            if (commentImages.length < 9) {
                const upload = document.createElement('div');
                upload.className = 'image-upload';
                upload.onclick = uploadImage;
                upload.innerHTML = '<i class="far fa-image"></i>';
                commentImagesContainer.appendChild(upload);
            }
        }
        
        // 移除图片
        function removeImage(index) {
            commentImages.splice(index, 1);
            updateCommentImages();
        }
        
        // 发送评论
        function sendComment() {
            const commentText = commentInput.value.trim();
            if (commentText === '') {
                alert('请输入评论内容');
                return;
            }
            // 在这里处理发送评论的逻辑
            alert('评论发送成功');
            commentInput.value = '';
            commentImages = [];
            updateCommentImages();
        }
        
        // 显示删除确认弹窗
        function showDeleteConfirm(btn) {
            const modal = document.createElement('div');
            modal.className = 'delete-modal';
            modal.innerHTML = `
                <div class="delete-modal-content">
                    <div class="delete-modal-title">删除评论</div>
                    <div class="delete-modal-message">确定要删除这条评论吗？此操作不可恢复。</div>
                    <div class="delete-modal-actions">
                        <div class="delete-modal-btn cancel" onclick="this.closest('.delete-modal').remove()">取消</div>
                        <div class="delete-modal-btn confirm" onclick="deleteComment(this)">删除</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 删除评论
        function deleteComment(btn) {
            const modal = btn.closest('.delete-modal');
            const commentCard = btn.closest('.card');
            
            // 添加删除动画
            commentCard.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                commentCard.remove();
                modal.remove();
                
                // 检查是否还有评论
                const commentList = document.querySelector('.comment-list');
                if (!commentList.children.length) {
                    document.getElementById('no-comments').style.display = 'block';
                }
            }, 300);
        }
        
        // 添加删除动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);
        
        // 切换事件菜单
        function toggleEventMenu() {
            const menu = document.getElementById('eventMenu');
            menu.classList.toggle('show');
            
            // 点击其他地方关闭菜单
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.event-menu')) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // 显示状态选择器
        function showStatusSelector() {
            document.getElementById('statusSelector').classList.add('show');
            document.getElementById('eventMenu').classList.remove('show');
        }

        // 隐藏状态选择器
        function hideStatusSelector() {
            document.getElementById('statusSelector').classList.remove('show');
        }

        // 选择选项
        function selectOption(element) {
            // 移除所有选中样式
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 添加选中样式
            element.classList.add('selected');
        }

        // 更新状态
        function updateStatus(status) {
            const statusMap = {
                'ongoing': { 
                    text: '进行中', 
                    class: 'status-ongoing',
                    icon: '<i class="fas fa-circle" style="color: var(--primary-color); margin-right: 4px;"></i>'
                },
                'completed': { 
                    text: '已结束', 
                    class: 'status-completed',
                    icon: '<i class="fas fa-check-circle" style="color: #999999; margin-right: 4px;"></i>'
                }
            };

            // 更新主状态显示
            const statusElement = document.querySelector('.status-ongoing, .status-completed');
            const newStatus = statusMap[status];
            statusElement.innerHTML = newStatus.icon + newStatus.text;
            statusElement.className = newStatus.class;
            
            // 延迟关闭状态选择器，提供反馈时间
            setTimeout(() => {
                hideStatusSelector();
            }, 300);
        }

        // 删除时间线
        function deleteTimeline() {
            showDeleteProgressModal();
        }
        
        // 显示删除进展确认弹窗
        function showDeleteProgressModal() {
            document.getElementById('eventMenu').classList.remove('show');
            const modal = document.getElementById('deleteProgressModal');
            modal.classList.add('show');
            
            // 阻止滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏删除进展确认弹窗
        function hideDeleteProgressModal() {
            const modal = document.getElementById('deleteProgressModal');
            modal.classList.remove('show');
            
            // 恢复滚动
            document.body.style.overflow = '';
        }
        
        // 确认删除进展
        function confirmDeleteProgress() {
            // 添加删除动画
            const eventCard = document.querySelector('.event-card');
            eventCard.style.animation = 'fadeOut 0.5s ease forwards';
            
            // 显示删除中状态
            const confirmBtn = document.querySelector('.delete-progress-btn.confirm');
            const originalText = confirmBtn.textContent;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中';
            confirmBtn.style.pointerEvents = 'none';
            
            // 模拟删除请求
            setTimeout(() => {
                hideDeleteProgressModal();
                
                // 显示成功提示
                const successToast = document.createElement('div');
                successToast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 16px 32px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 2000;
                `;
                successToast.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 进展已删除';
                document.body.appendChild(successToast);
                
                // 2秒后跳转
                setTimeout(() => {
                    window.location.href = 'event-detail.html';
                }, 1500);
            }, 1000);
        }
    </script>
</body>
</html>